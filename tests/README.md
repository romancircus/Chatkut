# ChatKut E2E Tests

Comprehensive end-to-end testing suite using Playwright.

## Test Coverage

### 01-project-creation.spec.ts
Tests basic project management:
- Create new project
- Navigate to dashboard
- Verify 3-panel layout
- Handle empty states
- Navigate between projects

**Prerequisites:** None (works without API keys)

### 02-video-upload.spec.ts
Tests file upload functionality:
- Upload video files via TUS
- Track upload progress
- Verify assets in library
- HLS video preview
- Multiple file uploads
- Error handling

**Prerequisites:**
- `CLOUDFLARE_ACCOUNT_ID`
- `CLOUDFLARE_STREAM_API_TOKEN`
- `CLOUDFLARE_R2_ACCESS_KEY`
- `CLOUDFLARE_R2_SECRET_KEY`

### 03-ai-chat-editing.spec.ts
Tests natural language video editing:
- Send chat messages
- Receive AI responses
- Execute edit commands
- Update element properties
- Handle ambiguous selectors
- Undo/redo operations
- Edit receipts
- Chat history persistence

**Prerequisites:**
- At least ONE of:
  - `ANTHROPIC_API_KEY` (Claude Sonnet 4.5)
  - `OPENAI_API_KEY` (GPT-4o)
  - `GOOGLE_API_KEY` (Gemini Flash 2.0)

### 04-disambiguator.spec.ts
Tests disambiguation UI:
- Show disambiguator for ambiguous queries
- Display multiple options
- Select correct element
- Apply edit to specific element
- Cancel disambiguation
- Handle edge cases (single match, no matches)

**Prerequisites:** Same as 03-ai-chat-editing.spec.ts

### 05-render-workflow.spec.ts
Tests cloud rendering:
- Estimate render cost
- Start render job
- Track progress
- Download result
- Handle errors
- Cancel renders
- Multiple codec support
- Quality settings

**Prerequisites:**
- `REMOTION_AWS_REGION`
- `REMOTION_FUNCTION_NAME`
- `REMOTION_S3_BUCKET`
- AWS credentials configured

## Setup

### 1. Install Dependencies

```bash
npm install
```

This will install Playwright and all test dependencies.

### 2. Install Browsers

```bash
npx playwright install
```

Or install specific browser:

```bash
npx playwright install chromium
```

### 3. Configure Environment Variables

Create `.env.local` from `.env.example`:

```bash
cp .env.example .env.local
```

Fill in the required values:

```bash
# Convex (auto-generated by npx convex dev)
CONVEX_DEPLOYMENT=
NEXT_PUBLIC_CONVEX_URL=

# AI Models (at least ONE required)
ANTHROPIC_API_KEY=your_key_here
OPENAI_API_KEY=your_key_here
GOOGLE_API_KEY=your_key_here

# Cloudflare (for upload tests)
CLOUDFLARE_ACCOUNT_ID=your_account_id
CLOUDFLARE_STREAM_API_TOKEN=your_token
CLOUDFLARE_R2_ACCESS_KEY=your_key
CLOUDFLARE_R2_SECRET_KEY=your_secret

# Remotion Lambda (for render tests)
REMOTION_AWS_REGION=us-east-1
REMOTION_FUNCTION_NAME=remotion-render-lambda
REMOTION_S3_BUCKET=chatkut-renders
```

### 4. Start Development Servers

**Terminal 1 - Convex:**
```bash
npx convex dev
```

**Terminal 2 - Next.js:**
```bash
npm run dev
```

Wait for both servers to be ready before running tests.

## Running Tests

### Run All Tests

```bash
npm test
```

Or:

```bash
npx playwright test
```

### Run Specific Test File

```bash
npx playwright test tests/e2e/01-project-creation.spec.ts
```

### Run Tests in UI Mode (Interactive)

```bash
npx playwright test --ui
```

### Run Tests in Debug Mode

```bash
npx playwright test --debug
```

### Run Tests in Headed Mode (See Browser)

```bash
npx playwright test --headed
```

### Run Only Tests Without Prerequisites

```bash
npx playwright test tests/e2e/01-project-creation.spec.ts
```

This test suite doesn't require API keys.

### Run Tests with Specific Browser

```bash
npx playwright test --project=chromium
```

### Generate Test Report

After running tests:

```bash
npx playwright show-report
```

## Test Helpers

All tests use helper functions from `tests/e2e/helpers.ts`:

- `createProject(page, name)` - Create new project
- `navigateToProject(page, id)` - Go to project dashboard
- `sendChatMessage(page, message)` - Send AI chat message
- `waitForUploadComplete(page, filename)` - Wait for file upload
- `clickUndo(page)` - Click undo button
- `clickRedo(page)` - Click redo button
- `selectDisambiguatorOption(page, index)` - Select disambiguation option
- `startRender(page, codec)` - Start render job
- `waitForRenderComplete(page)` - Wait for render to finish
- `assertNoConsoleErrors(page)` - Verify no console errors

## Test Fixtures

Place test files in `tests/fixtures/`:

- `test-video.mp4` - Small test video (~1-10MB)
- `test-video-1.mp4`, `test-video-2.mp4` - For multi-upload tests
- `invalid.txt` - Non-video file for error testing

These are optional - tests will skip if files don't exist.

## CI/CD Integration

Add to GitHub Actions:

```yaml
name: E2E Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Run tests
        run: npm test
        env:
          # Add secrets as GitHub repository secrets
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          # ... other secrets

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/
```

## Troubleshooting

### Tests Timing Out

- Increase timeout in `playwright.config.ts`:
  ```typescript
  timeout: 120 * 1000, // 2 minutes
  ```
- Or in individual tests:
  ```typescript
  test.setTimeout(180000); // 3 minutes
  ```

### Convex Connection Errors

- Verify Convex dev server is running on port 3210
- Check `CONVEX_DEPLOYMENT` and `NEXT_PUBLIC_CONVEX_URL` in `.env.local`
- Run `npx convex dev` first before tests

### Upload Tests Failing

- Verify Cloudflare credentials are correct
- Check Cloudflare Stream API is enabled
- Ensure R2 bucket exists and is accessible
- Test files must be valid video formats

### AI Tests Failing

- Verify at least one AI API key is set
- Check API key has sufficient credits
- AI responses may vary - tests should be flexible
- Increase timeout for slow AI responses

### Render Tests Failing

- Verify Remotion Lambda is deployed
- Check AWS credentials are configured
- Ensure S3 bucket exists and is accessible
- Render tests can take 5-10 minutes

### Browser Not Found

```bash
npx playwright install chromium
```

### Port Already in Use

Change port in `playwright.config.ts`:

```typescript
webServer: [
  {
    command: 'npm run dev',
    url: 'http://localhost:3002', // Change port
  }
]
```

And update `next.config.js`:

```javascript
module.exports = {
  devServer: {
    port: 3002,
  },
};
```

## Best Practices

1. **Test Isolation** - Each test should be independent
2. **Wait for Sync** - Always call `waitForConvexSync()` after mutations
3. **Flexible Selectors** - Use data attributes and roles, not class names
4. **Error Handling** - Tests should handle async failures gracefully
5. **Screenshots** - Take screenshots on failure (enabled by default)
6. **Cleanup** - Don't leave test data behind (optional in MVP)

## Writing New Tests

Template for new test:

```typescript
import { test, expect } from '@playwright/test';
import { createProject, navigateToProject } from './helpers';

test.describe('My Feature', () => {
  test('should do something', async ({ page }) => {
    // Setup
    await page.goto('/');
    const projectId = await createProject(page, `Test ${Date.now()}`);
    await navigateToProject(page, projectId);

    // Test action
    await page.getByRole('button', { name: /action/i }).click();

    // Assertion
    await expect(page.getByText(/result/i)).toBeVisible();
  });
});
```

## Test Statistics

| Test File | Tests | Duration (avg) | Prerequisites |
|-----------|-------|----------------|---------------|
| 01-project-creation | 5 | ~30s | None |
| 02-video-upload | 7 | ~2-5min | Cloudflare |
| 03-ai-chat-editing | 12 | ~3-10min | AI API |
| 04-disambiguator | 10 | ~2-5min | AI API |
| 05-render-workflow | 15 | ~5-30min | Remotion Lambda |
| **Total** | **49** | **15-50min** | Full setup |

## Next Steps

After tests pass:

1. ✅ Fix any failing tests
2. ✅ Add more edge case coverage
3. ✅ Set up CI/CD pipeline
4. ✅ Add visual regression tests (optional)
5. ✅ Performance testing (optional)

## Support

For test issues:
- Check `READY_FOR_TESTING.md` for manual testing workflows
- Review `CURRENT_STATUS.md` for implementation status
- See `GAP_ANALYSIS.md` for known limitations
